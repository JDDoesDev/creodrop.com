---
interface Props {
  code: string;
  lang?: string;
}

const { code, lang = 'text' } = Astro.props;
---

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang">{lang}</span>
    <button class="code-copy-btn" data-code={code} aria-label="Copy code">
      <svg class="code-copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
      <svg class="code-check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" hidden>
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
      <span class="code-copy-text">Copy</span>
    </button>
  </div>
  <pre><code class={`language-${lang}`}>{code}</code></pre>
</div>

<script>
  function initCopyButtons() {
    document.querySelectorAll('.code-copy-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const code = button.getAttribute('data-code');
        if (!code) return;

        try {
          await navigator.clipboard.writeText(code);

          const copyIcon = button.querySelector('.code-copy-icon');
          const checkIcon = button.querySelector('.code-check-icon');
          const text = button.querySelector('.code-copy-text');

          if (copyIcon && checkIcon && text) {
            copyIcon.setAttribute('hidden', '');
            checkIcon.removeAttribute('hidden');
            text.textContent = 'Copied!';

            setTimeout(() => {
              copyIcon.removeAttribute('hidden');
              checkIcon.setAttribute('hidden', '');
              text.textContent = 'Copy';
            }, 2000);
          }
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }

  initCopyButtons();
  document.addEventListener('astro:after-swap', initCopyButtons);
</script>
