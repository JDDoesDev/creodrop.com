---
interface Props {
  chart: string;
  caption?: string;
}

const { chart, caption } = Astro.props;
const id = `mermaid-${Math.random().toString(36).substring(2, 9)}`;
---

<figure class="mermaid-container">
  <div class="mermaid-diagram" id={id} data-chart={chart}>
    <div class="mermaid-loading">Loading diagram...</div>
  </div>
  {caption && <figcaption class="mermaid-caption">{caption}</figcaption>}
</figure>

<script>
  async function initMermaid() {
    const diagrams = document.querySelectorAll('.mermaid-diagram[data-chart]');

    if (diagrams.length === 0) return;

    // Dynamically import mermaid
    const mermaid = (await import('mermaid')).default;

    // Detect dark mode
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      securityLevel: 'loose',
      fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
    });

    diagrams.forEach(async (diagram) => {
      const chart = diagram.getAttribute('data-chart');
      const id = diagram.id;

      if (!chart) return;

      try {
        const { svg } = await mermaid.render(`${id}-svg`, chart);
        diagram.innerHTML = svg;
      } catch (err) {
        console.error('Mermaid rendering error:', err);
        diagram.innerHTML = '<div class="mermaid-error">Failed to render diagram</div>';
      }
    });
  }

  // Initialize on load
  initMermaid();

  // Re-initialize after Astro navigation
  document.addEventListener('astro:after-swap', initMermaid);

  // Re-render on color scheme change
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', initMermaid);
</script>
